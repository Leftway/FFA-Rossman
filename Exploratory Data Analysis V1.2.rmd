---
title: "Rossman Store Sales "
subtitle: "Group 1 - Exploratory Data Analysis"
author: '1. Kang Jun Han Brandon, 2.Kenny Sim Jun Hong, 3. Lim Yong Chuan,  4. Tan Soon Wei,  5. Teo Xiangquan Martin'
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: 
    tufte_variant: "default"
    self_contained: yes
---
```{r libraries, include = FALSE}
# Install & load relevant libraries. 
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, 
               ggplot2,
               lubridate, 
               plotly,
               kableExtra,
               Knitr)

# Create html_df for later stlying
html_df <- function(x){
  kable(x) %>%
   kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}
```

# Importing and cleaning data
## 1. Import files
``` {r Import, eval = TRUE}
# a. Import train.csv
train <- read.csv("train.csv", stringsAsFactors = F)

# b. Import test.csv
test <- read.csv("test.csv", stringsAsFactors = F)

# c.  Import store.csv
store <- read.csv("store.csv", stringsAsFactors = F)

```
## 2. Data Structure
+ Train has `r dim(train)[1]` rows and `r dim(train)[2]` columns.
+ Test has `r dim(test)[1]` rows and `r dim(test)[2]` columns.
+ Store has `r dim(store)[1]`rows and `r dim(store)[2]` columns.

```{r Data structure, eval = TRUE}
# Structure - Unsure if we've to put this
# str(train)
# str(test)
# str(store)
```


## 3. Check for NA values
```{r NA values, eval = TRUE}
# a. Train 
train %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df

# b. Test 
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")

# c. Store
store %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df

```

## 4. Imputing missing values for test
``` {r Impute, eval = TRUE}
# a. Retrieve records with Open = NA
test %>% filter(is.na(Open)) %>% html_df()

# b. Replace NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))

# c. Check if NA has been replaced:
sum(is.na(test$Open))
```
_Explanation_:

It is more prudent to assume store 622 is open (1) on those days than to assume it is not (0). 

This is because if the store is actually open (1) but sales is predicted as 0, this wrong prediction will reduce the overall prediction's accuracy. Conversely, if the store is actually not open (0) but sales



## 3. Convert data types
``` {r Converting data, eval = TRUE}
#a. Train
train <- train %>% mutate(
  DayOfWeek                 = as.factor(DayOfWeek),
  Date                      = as.Date(Date),
  Open                      = as.factor(Open),
  Promo                     = as.factor(Promo), 
  StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
  SchoolHoliday             = as.factor(SchoolHoliday))
str(train)

#b. Test
test <- test %>% mutate(
  DayOfWeek                 = as.factor(DayOfWeek),
  Date                      = as.Date(Date),
  Open                      = as.factor(Open),
  Promo                     = as.factor(Promo),
  StateHoliday              = as.factor(StateHoliday),   # Only 2 values! What're the state holidays?
  SchoolHoliday             = as.factor(SchoolHoliday))
str(test)

#c. Store
store <- store %>% mutate(
  StoreType                 = as.factor(StoreType),
  Assortment                = as.factor(Assortment),
  Promo2                    = as.factor(Promo2))
str(store)

```


# Exploratory Data Analysis
## 1. Dates
Sales data start from `r min(train$Date)` to `r max(train$Date)`, which spans a total of `r max(train$Date) - min(train$Date)` days or 2 years 7 months.

Extract individual date components 
```{r, eval = TRUE }
# Training
train$day <- as.integer(format(train$Date, "%d"))
train$month <- as.integer(format(train$Date, "%m"))
train$year <- as.integer(format(train$Date, "%Y"))

# Test
test$day <- as.integer(format(test$Date, "%d"))
test$month <- as.integer(format(test$Date, "%m"))
test$year <- as.integer(format(test$Date, "%Y"))
```

## 2. Skewedness of data
```{r, eval = TRUE}
#group revenues by quarter
train <- train %>%
          mutate(quarters = paste0(substr(Date,1,4),quarters(as.Date(Date))))

train <- train %>% 
          group_by(quarters) %>%
          mutate(revtq = sum(Sales,na.rm = TRUE)) %>%
          ungroup()
```


          
