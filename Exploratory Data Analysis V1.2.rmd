---
title: "Rossman Store Sales "
subtitle: "Group 1 - Exploratory Data Analysis"
author: '1. Kang Jun Han Brandon, 2.Kenny Sim Jun Hong, 3. Lim Yong Chuan,  4. Tan Soon Wei,  5. Teo Xiangquan Martin'
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: 
    tufte_variant: "default"
    self_contained: yes
---
```{r libraries, include = FALSE}
# Install & load relevant libraries. 
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, 
               ggplot2,
               lubridate, 
               plotly,
               kableExtra,
               Knitr)

# Create html_df for later stlying
html_df <- function(x){
  kable(x) %>%
   kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
}
```

# Importing and cleaning data
## 1. Import files
``` {r Import, eval = TRUE}
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
```

## 2. Data Structure
```{r Dimensions Check, include = FALSE}
 str(train)
 str(test)
 str(store)
 dim(train)
 dim(test)
 dim(store)
```
 
```{r Data Structure, eval = TRUE}
# Rows and columns of each file
  matrix(c("1017209", "9", "41088", "8", "1115", "10"),ncol=2, byrow= TRUE)                                             %>% as.data.frame() %>% `row.names<-`(c("Train", "Test", "Store"))                                                %>% `colnames<-`(c("No. of Rows", "No. of Columns")) %>% html_df
```

## 3. Check for NA 
```{r NA values train, eval = TRUE}
# Train 
train %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df

# Test 
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
```

_Observations_:

+ Variable 'Open' should have only two possible values (Open = 1 or Closed = 0), so the 11 NA's should be changed to either 1 or 0.
+ If Open is = 1, but we assume = 0, the error score will increase because of misprediction.
+ If Open is = 0, but we assume = 1, then there's no penalty in scoring as closed stores with 0 sales are not considered in scoring. 

Hence, we will impute 1 into the NA values for the 'Open' variable in

```{r NA values - Store, eval = TRUE }
# Store
store %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df
```



## 4. Imputing missing values for test
``` {r Impute, eval = TRUE}
# a. Retrieve records with Open = NA
test %>% filter(is.na(Open)) %>% html_df()

# b. Replace NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))

# c. Check if NA has been replaced:
sum(is.na(test$Open))
```
_Explanation_:

It is more prudent to assume store 622 is open (1) on those days than to assume it is not (0). 

This is because if the store is actually open (1) but sales is predicted as 0, this wrong prediction will reduce the overall prediction's accuracy. Conversely, if the store is actually not open (0) but sales



## 3. Convert data types
``` {r Converting data, eval = TRUE}
#a. Train
train <- train %>% mutate(
  DayOfWeek                 = as.factor(DayOfWeek),
  Date                      = as.Date(Date),
  Open                      = as.factor(Open),
  Promo                     = as.factor(Promo), 
  StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
  SchoolHoliday             = as.factor(SchoolHoliday))
str(train)

#b. Test
test <- test %>% mutate(
  DayOfWeek                 = as.factor(DayOfWeek),
  Date                      = as.Date(Date),
  Open                      = as.factor(Open),
  Promo                     = as.factor(Promo),
  StateHoliday              = as.factor(StateHoliday),   # Only 2 values! What're the state holidays?
  SchoolHoliday             = as.factor(SchoolHoliday))
str(test)

#c. Store
store <- store %>% mutate(
  StoreType                 = as.factor(StoreType),
  Assortment                = as.factor(Assortment),
  Promo2                    = as.factor(Promo2))
str(store)

```


# Exploratory Data Analysis
## 1. Dates
Sales data start from `r min(train$Date)` to `r max(train$Date)`, which spans a total of `r max(train$Date) - min(train$Date)` days or 2 years 7 months.

Extract individual date components 
```{r, eval = TRUE }
# Training
train$day <- as.integer(format(train$Date, "%d"))
train$month <- as.integer(format(train$Date, "%m"))
train$year <- as.integer(format(train$Date, "%Y"))

# Test
test$day <- as.integer(format(test$Date, "%d"))
test$month <- as.integer(format(test$Date, "%m"))
test$year <- as.integer(format(test$Date, "%Y"))
```

## 2. Skewedness of data
```{r, eval = TRUE}
#group revenues by quarter
train <- train %>%
          mutate(quarters = paste0(substr(Date,1,4),quarters(as.Date(Date))))

train <- train %>% 
          group_by(quarters) %>%
          mutate(revtq = sum(Sales,na.rm = TRUE)) %>%
          ungroup()
```


          
