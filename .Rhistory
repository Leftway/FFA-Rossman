<<<<<<< HEAD
View(test)
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
))
test <- test %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
))
week_day <- paste0(train$year, "W", train$week)
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year == paste0(train$year, "W", train$week))
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(train$year, "W", train$week))
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
View(train)
View(train)
test <- test %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
train.df <- train %>%
group_by(Store, week_year) %>%
mutate(store_avg=mean(Sales, rm.na=T)) %>%
ungroup()
View(train.df)
train.df <- train.df %>%
group_by(Store, week_year) %>%
slice(1) %>%
select(Store,store_avg) %>%
ungroup()
train.df <- train.df %>%
group_by(Store, week_year) %>%
slice(1) %>%
select(week_year,Store,store_avg) %>%
ungroup()
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales.gr = store_avg / lag(store_avg) - 1
)
View(train.dy)
sales.daily_plot <- ggplot(data = train.dy,
mapping = aes(x = store_avg))
sales.daily_plot + geom_density()
sales.gr_plot <- ggplot(data = train.dy,
mapping = aes(x = sales.gr))
sales.gr_plot + geom_density()
train.df <- train %>%
group_by(Store, week_year) %>%
mutate(store_avg=mean(Sales, rm.na=T)) %>%
ungroup()
train.df <- train.df %>%
group_by(Store, week_year) %>%
slice(1) %>%
select(week_year,Store,store_avg,week) %>%
ungroup()
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales.gr = store_avg / lag(store_avg) - 1
)
ggplot(train.dy,aes(week,Sales)) +
geom_bar(stat = "identity")
ggplot(train.dy,aes(as.numeric(week),Sales)) +
geom_bar(stat = "identity")
View(train.dy)
as.numeric(train.dy$week)
ggplot(train.dy,aes(as.numeric(train.dy$week),Sales)) +
geom_bar(stat = "identity")
ggplot(train.dy,aes(as.numeric(week),store_avg)) +
geom_bar(stat = "identity")
ggplot(train.dy,aes(as.numeric(week),store_avg)) +
geom_bar(stat = "identity")
ggplot(train.dy,aes(as.numeric(week),sales.gr)) +
geom_bar(stat = "identity")
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = isoweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = isoweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = epiweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
View(train)
View(train)
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = epiweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
test <- test %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = isoweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
train.df <- train %>%
group_by(Store, week_year) %>%
mutate(store_avg=mean(Sales, rm.na=T)) %>%
ungroup()
train.df <- train.df %>%
group_by(Store, week_year) %>%
slice(1) %>%
select(week_year,Store,store_avg,week) %>%
ungroup()
View(train.df)
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales.gr = store_avg / lag(store_avg) - 1
)
View(train.dy)
plot <- train.dy %>%
ggplot(aes(y=store_avg, x=sales.gr, color=factor(as.number(week)))) +
labs(title="[Fiscal] Relationship Between Last Quarter Revenue and Revenue", x="Last Quarter Revenue", y="Revenue") +
geom_point()+
geom_smooth(method=lm, se=FALSE, fullrange=TRUE)
#Make the plot interactive
ggplotly(plot)  # No need to change this line
plot <- train.dy %>%
ggplot(aes(y=store_avg, x=sales.gr, color=factor(as.numeric(week)))) +
labs(title="[Fiscal] Relationship Between Last Quarter Revenue and Revenue", x="Last Quarter Revenue", y="Revenue") +
geom_point()+
geom_smooth(method=lm, se=FALSE, fullrange=TRUE)
#Make the plot interactive
ggplotly(plot)  # No need to change this line
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg)
)
sales.weekly_plot <- ggplot(data = train.dy,
mapping = aes(x = store_avg))
sales.weekly_plot + geom_density()
sales_gr_plot <- ggplot(data = train.dy,
mapping = aes(x = sales_gr))
sales_gr_plot + geom_density()
sales_d_plot <- ggplot(data = train.dy,
mapping = aes(x = sales_d))
sales_d_plot + geom_density()
ggplot(train.dy,aes(as.numeric(week),store_avg)) +
geom_bar(stat = "identity")
ggplot(train.dy,aes(as.numeric(week),sales_gr)) +
geom_bar(stat = "identity")
ggplot(train.dy,aes(as.numeric(week),sales_d)) +
geom_bar(stat = "identity")
plot <- train.dy %>%
ggplot(aes(y=store_avg, x=sales_d, color=factor(as.numeric(week)))) +
labs(title="[Fiscal] Relationship Between Last Quarter Revenue and Revenue", x="Last Quarter Revenue", y="Revenue") +
geom_point()+
geom_smooth(method=lm, se=FALSE, fullrange=TRUE)
#Make the plot interactive
ggplotly(plot)  # No need to change this line
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="complete.obs")
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg),
na.rm =TRUE
)
y
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="complete.obs")
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="complete.obs", na.rm = TRUE)
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="complete.obs")
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="complete.obs")
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="pairwise.complete.obs")
train.dy[mapply(is.infinite, train.dy)] <- NA
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg)
)
train.dy[mapply(is.infinite, train.dy)] <- NA
cor(train.dy[,c("store_avg","sales_gr","sales_d")],
use="complete.obs")
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg),
sales_yoy = store_avg/lag(store_avg,53) -1
)
train.dy[mapply(is.infinite, train.dy)] <- NA
sales_d_plot <- ggplot(data = train.dy,
mapping = aes(x = sales_yoy))
sales_d_plot + geom_density()
cor(train.dy[,c("store_avg","sales_gr","sales_d","sales_yoy")],
use="complete.obs")
multi_lag <- function(train.dy, lags, var, ext=""){
lag_names <- paste0(var,ext,lags)
lag_funs <- setNames(paste("dplyr::lag(.,",lags,")"), lag_names)
train.dy %>% group_by(Store) %>% mutate_at(vars(var), funs_(lag_funs)) %>% ungroup()
}
train.dy <- multi_lag(train.dy, 1:53, "sales_d")
train.dy <- multi_lag(train.dy, 1:53, "sales_gr")
train.dy <- multi_lag(train.dy, 0:53, "sales_d")
train.dy <- multi_lag(train.dy, 0:53, "sales_gr")
train.dy <- multi_lag(train.dy, 1:53, "sales_d")
train.dy <- multi_lag(train.dy, 1:53, "sales_gr")
cor(train.dy[,c(.~)],
cor(train.dy[,unlist(lapply(train.dy, is.numeric))],
use="complete.obs")
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg),
sales_yoy = store_avg/lag(store_avg,53) -1
)
train.dy <- multi_lag(train.dy, 1:53, "store_avg")
cor(train.dy[,unlist(lapply(train.dy, is.numeric))],
use="complete.obs")
train.dy[mapply(is.infinite, train.dy)] <- NA
#####################################################################################33
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
#####################################################################################33
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = epiweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
test <- test %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = isoweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
#calculate average sales by store-type-assort
train.df <- train %>%
group_by(Store, week_year) %>%
mutate(store_avg=mean(Sales, rm.na=T)) %>%
ungroup()
#select the first average sales data for each store-type-assort
train.df <- train.df %>%
group_by(Store, week_year) %>%
slice(1) %>%
select(week_year,Store,store_avg,week) %>%
ungroup()
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg),
sales_yoy = store_avg/lag(store_avg,53) -1
)
multi_lag <- function(train.dy, lags, var, ext=""){
lag_names <- paste0(var,ext,lags)
lag_funs <- setNames(paste("dplyr::lag(.,",lags,")"), lag_names)
train.dy %>% group_by(Store) %>% mutate_at(vars(var), funs_(lag_funs)) %>% ungroup()
}
train.dy <- multi_lag(train.dy, 1:53, "store_avg")
train.dy <- multi_lag(train.dy, 1:53, "sales_d")
train.dy <- multi_lag(train.dy, 1:53, "sales_gr")
n
cor(train.dy[,unlist(lapply(train.dy, is.numeric))],
use="complete.obs")
=======
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday))
#b. Test
test <- test %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Only 2 values! What're the state holidays?
SchoolHoliday             = as.factor(SchoolHoliday))
#c. Store
store <- store %>% mutate(
StoreType                 = as.factor(StoreType),
Assortment                = as.factor(Assortment),
Promo2                    = as.factor(Promo2),
PromoInterval             = as.factor(PromoInterval),
CompetitionOpenSinceMonth = as.numeric(CompetitionOpenSinceMonth),
CompetitionOpenSinceYear  = as.numeric(CompetitionOpenSinceYear))
# a. Impute NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))
# b. Check if NA has been replaced:
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,
ggplot2,
lubridate,
plotly,
mice,
kableExtra,
zoo,
plotly,
Scale,
forecast,
rpart,
caret,
e1071,
MICE)
# Create html_df for later stlying
html_df <- function(x){
kable(x) %>%
kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# a. Impute NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))
# b. Check if NA has been replaced:
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
# Initialize mice algorithm where it use information from other variables in the dataset to predict and impute the missing values
init = mice(store, maxit = 0)
meth = init$method
predM = init$predictorMatrix
# Store ID variable does not have any predictive value, Select the BMI variable to not be included as predictor during imputation
predM[, c("Store")] = 0
# Specify methods for inputing values
meth[c("CompetitionOpenSinceMonth")]="norm"
meth[c("CompetitionOpenSinceYear")]="norm"
meth[c("Promo2SinceWeek")]="norm"
meth[c("Promo2SinceYear")]="norm"
# Run multiple imputation
set.seed(111)
imputed = mice(store, method=meth, predictorMatrix=predM, m=10)
# Replace store with inputed missing value dataset
store <- complete(imputed)
store$CompetitionOpenSinceMonth <- round(store$CompetitionOpenSinceMonth, digits = 0)
store$CompetitionOpenSinceYear <- round(store$CompetitionOpenSinceYear, digits = 0)
store$Promo2SinceWeek <- round(store$Promo2SinceWeek, digits = 0)
store$Promo2SinceYear <- round(store$Promo2SinceYear, digits = 0)
store <- store %>%
mutate(CompetitionOpenSinceMonth = replace(CompetitionOpenSinceMonth, CompetitionOpenSinceMonth<1, 1),
CompetitionOpenSinceMonth = replace(CompetitionOpenSinceMonth, CompetitionOpenSinceMonth>12, 12),
CompetitionOpenSinceYear = replace(CompetitionOpenSinceYear, CompetitionOpenSinceYear>2015, 2015),
Promo2SinceWeek = replace(Promo2SinceWeek, Promo2SinceWeek<1, 1),
Promo2SinceWeek = replace(Promo2SinceWeek, Promo2SinceWeek>50, 50),
Promo2SinceYear = replace(Promo2SinceYear, Promo2SinceYear<2009, 2009),
Promo2SinceYear = replace(Promo2SinceYear, Promo2SinceYear>2015, 2015)
)
# Last check for NAs
store %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>%
row_spec(c(4,5,6,8,9), bold = T, color = "red")
# a. Create new date variables
store <- store %>%
mutate(CompetitionOpenSince = as.yearmon(paste(store$CompetitionOpenSinceYear, store$CompetitionOpenSinceMonth, sep = "-")),
Promo2Since = as.POSIXct(paste(store$Promo2SinceYear,store$Promo2SinceWeek, 1, sep = "-"),format = "%Y-%U-%u"))
# P.S: yearmon functon creates a numeric vector interpreted in "years" and fractions of years. e.g. 1961.5 = June 1961.
# b. Remove redundant date variables
store <- store %>% dplyr::select(-c(Promo2SinceWeek, Promo2SinceYear, CompetitionOpenSinceMonth, CompetitionOpenSinceYear))
train.store <- merge(train, store, by = "Store")
test.store <- merge(test, store, by = "Store")
rm(store)
rm(test)
rm(train)
# Previous stored variables removed so only correct data set is used.
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
View(train.store)
train.store %>% table()
train.store$CompetitionOpenSince %>% table()
train.store$CompetitionOpenSince %>% tally() %>% table()
train.store$CompetitionOpenSince %>% summary()
train.store$CompetitionOpenSince
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"),
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer( format(Date+3, "%U")) # Kenny is this correct?
#b. Test
test <- test %>% mutate(
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
#a. Train
train <- train %>% mutate(
#a. Train
train <- train %>% mutate(
#b. Test
test <- test %>% mutate(
test <- test %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Only 2 values! What're the state holidays?
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"),
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer( format(Date+3, "%U"))
train <- train %>% mutate(
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"),
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer(format(Date+3, "%U")))))) # Kenny is this correct?
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"),
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer(format(Date+3, "%U")))))) # Kenny is this correct?
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"))
,
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer(format(Date+3, "%U")))))) # Kenny is this correct?
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"))
Year                      = as.integer(format(Date, "%y"),
DayOfWeek                 = as.factor(DayOfWeek),
#a. Train
train <- train %>% mutate(
#a. Train
train <- train %>% mutate(
train <- train %>% mutate(
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek)
Date                      = as.Date(Date),
train <- train %>% mutate(
train <- train %>% mutate
train <- train %>% mutate(
train <- train %>% mutate(
train <- train %>% mutate(
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,     ggplot2,       lubridate,             plotly,
mice,          kableExtra,    zoo,                   Scale,
forecast,      rpart,         caret,                 e1071,       MICE)
# Create html_df for later stlying
html_df <- function(x){
kable(x) %>%
kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,     ggplot2,       lubridate,             plotly,
mice,          kableExtra,    zoo,                   Scale,
forecast,      rpart,         caret,                 e1071,       MICE)
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m")),
Year                      = as.integer(format(Date, "%y")),
Day                       = as.integer(format(Date, "%d")),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer(format(Date+3, "%U"))) # Kenny is this correct?
#b. Test
test <- test %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Only 2 values! What're the state holidays?
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"),
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer( format(Date+3, "%U"))))))
#c. Store
store <- store %>% mutate(
StoreType                 = as.factor(StoreType),
Assortment                = as.factor(Assortment),
Promo2                    = as.factor(Promo2),
PromoInterval             = as.factor(PromoInterval),
CompetitionOpenSinceMonth = as.numeric(CompetitionOpenSinceMonth),
CompetitionOpenSinceYear  = as.numeric(CompetitionOpenSinceYear))
View(train)
# a. Impute NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))
# b. Check if NA has been replaced:
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
# Store
store %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
test.store <- merge(test, store, by = "Store")
train.store <- merge(train, store, by = "Store")
test.store <- merge(test, store, by = "Store")
rm(store)
rm(test)
rm(train)
# Previous stored variables removed so only correct data set is used.
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,     ggplot2,       lubridate,             plotly,
mice,          kableExtra,    zoo,                   Scale,
forecast,      rpart,         caret,                 e1071,       MICE)
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,     ggplot2,       lubridate,             plotly,
mice,          kableExtra,    zoo,                   Scale,
forecast,      rpart,         caret,                 e1071,       mice)
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,     ggplot2,       lubridate,             plotly,
mice,          kableExtra,    zoo,                   Scale,
forecast,      rpart,         caret,                 e1071,       mice)
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
#a. Train
train <- train %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Has 4 values!
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m")),
Year                      = as.integer(format(Date, "%y")),
Day                       = as.integer(format(Date, "%d")),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer(format(Date+3, "%U")))
#b. Test
test <- test %>% mutate(
DayOfWeek                 = as.factor(DayOfWeek),
Date                      = as.Date(Date),
Open                      = as.factor(Open),
Promo                     = as.factor(Promo),
StateHoliday              = as.factor(StateHoliday),   # Only 2 values! What're the state holidays?
SchoolHoliday             = as.factor(SchoolHoliday),
Month                     = as.integer(format(Date, "%m"),
Year                      = as.integer(format(Date, "%y"),
Day                       = as.integer(format(Date, "%d"),
DayofYear                 = as.integer(as.POSIXlt(Date)$yday),
Week                      = as.integer( format(Date+3, "%U"))))))
#c. Store
store <- store %>% mutate(
StoreType                 = as.factor(StoreType),
Assortment                = as.factor(Assortment),
Promo2                    = as.factor(Promo2),
PromoInterval             = as.factor(PromoInterval),
CompetitionOpenSinceMonth = as.numeric(CompetitionOpenSinceMonth),
CompetitionOpenSinceYear  = as.numeric(CompetitionOpenSinceYear))
View(train)
# Train
train %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df
# a. Impute NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))
# b. Check if NA has been replaced:
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
train.store <- merge(train, store, by = "Store")
test.store <- merge(test, store, by = "Store")
# rm(store)
# rm(test)
# rm(train)
# Previous stored variables removed so only correct data set is used.
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
# a. Create new date variables
store <- store %>%
mutate(CompetitionOpenSince = as.yearmon(paste(store$CompetitionOpenSinceYear, store$CompetitionOpenSinceMonth, sep = "-")),
Promo2Since = as.POSIXct(paste(store$Promo2SinceYear,store$Promo2SinceWeek, 1, sep = "-"),format = "%Y-%U-%u"))
# P.S: yearmon functon creates a numeric vector interpreted in "years" and fractions of years. e.g. 1961.5 = June 1961.
# b. Remove redundant date variables
store <- store %>% dplyr::select(-c(Promo2SinceWeek, Promo2SinceYear, CompetitionOpenSinceMonth, CompetitionOpenSinceYear))
train.store <- merge(train, store, by = "Store")
test.store <- merge(test, store, by = "Store")
# rm(store)
# rm(test)
# rm(train)
# Previous stored variables removed so only correct data set is used.
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
# Initialize mice algorithm where it use information from other variables in the dataset to predict and impute the missing values
init = mice(store, maxit = 0)
meth = init$method
predM = init$predictorMatrix
# Store ID variable does not have any predictive value, Select the BMI variable to not be included as predictor during imputation
predM[, c("Store")] = 0
# Specify methods for inputing values
meth[c("CompetitionOpenSinceMonth")]="norm"
meth[c("CompetitionOpenSinceYear")]="norm"
meth[c("Promo2SinceWeek")]="norm"
meth[c("Promo2SinceYear")]="norm"
# Run multiple imputation
set.seed(111)
imputed = mice(store, method=meth, predictorMatrix=predM, m=10)
# Initialize mice algorithm where it use information from other variables in the dataset to predict and impute the missing values
init = mice(store, maxit = 0)
meth = init$method
predM = init$predictorMatrix
# Store ID variable does not have any predictive value, Select the BMI variable to not be included as predictor during imputation
predM[, c("Store")] = 0
# Specify methods for inputing values
meth[c("CompetitionOpenSinceMonth")]="norm"
meth[c("CompetitionOpenSinceYear")]="norm"
meth[c("Promo2SinceWeek")]="norm"
meth[c("Promo2SinceYear")]="norm"
# Run multiple imputation
set.seed(111)
imputed = mice(store, method=meth, predictorMatrix=predM, m=10)
>>>>>>> master
# Import train.csv, test.csv and store.csv
train <- read.csv("train.csv", stringsAsFactors = F)
test <- read.csv("test.csv", stringsAsFactors = F)
store <- read.csv("store.csv", stringsAsFactors = F)
<<<<<<< HEAD
train <- train %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = epiweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
test <- test %>%
mutate(week = week(as.Date(Date)), year = year(as.Date(Date)), weekM = isoweek(as.Date(Date)),
week = case_when(
week == 1 ~ "01",
week == 2 ~ "02",
week == 3 ~ "03",
week == 4 ~ "04",
week == 5 ~ "05",
week == 6 ~ "06",
week == 7 ~ "07",
week == 8 ~ "08",
week == 9 ~ "09",
week == week ~ as.character(week)
),
week_year = paste0(year, "W", week))
#cleaning of missing data in store.csv
store <- store %>%
mutate(CompetitionOpenSinceMonth=ifelse(is.na(CompetitionOpenSinceMonth),median(CompetitionOpenSinceMonth,na.rm=T), CompetitionOpenSinceMonth),
CompetitionOpenSinceYear=ifelse(is.na(CompetitionOpenSinceYear),median(CompetitionOpenSinceYear,na.rm=T), CompetitionOpenSinceYear),
Promo2SinceYear=ifelse(is.na(Promo2SinceYear),0, Promo2SinceYear),
Promo2SinceWeek=ifelse(is.na(Promo2SinceWeek),0, Promo2SinceWeek))
#calculate average sales by store-type-assort
train.df <- train %>%
group_by(Store, week_year) %>%
mutate(store_avg=mean(Sales, rm.na=T)) %>%
ungroup()
#select the first average sales data for each store, week_year
train.df <- train.df %>%
group_by(Store, week_year) %>%
slice(1) %>%
select(week_year,Store,store_avg,week) %>%
ungroup()
train.dy <-
train.df %>%
group_by(Store) %>%
mutate(
sales_gr = store_avg / lag(store_avg) - 1,
sales_d = store_avg - lag(store_avg),
sales_yoy = store_avg/lag(store_avg,53) -1
)
multi_lag <- function(train.dy, lags, var, ext=""){
lag_names <- paste0(var,ext,lags)
lag_funs <- setNames(paste("dplyr::lag(.,",lags,")"), lag_names)
train.dy %>% group_by(Store) %>% mutate_at(vars(var), funs_(lag_funs)) %>% ungroup()
}
corr_store_avg <- multi_lag(train.dy, 1:53, "store_avg")
corr_sales_d <- multi_lag(train.dy, 1:53, "sales_d")
corr_sales_gr <- multi_lag(train.dy, 1:53, "sales_gr")
View(corr_sales_gr)
corr_store_avg <- multi_lag(train.dy, 1:53, "store_avg")[,-c(1:7)]
View(corr_store_avg)
View(corr_store_avg)
corr_store_avg <- multi_lag(train.dy, 1:53, "store_avg")[,-c(1:7)]
corr_sales_d <- multi_lag(train.dy, 1:53, "sales_d")[,-c(1:7)]
corr_sales_gr <- multi_lag(train.dy, 1:53, "sales_gr")[,-c(1:7)]
=======
# a. Impute NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))
# b. Check if NA has been replaced:
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
# Install & load relevant libraries.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse,     ggplot2,       lubridate,             plotly,
mice,          kableExtra,    zoo,                   Scale,
forecast,      rpart,         caret,                 e1071,       mice)
# Create html_df for later stlying
html_df <- function(x){ kable(x) %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")}
# a. Impute NA with Open = 1
test <- test %>% mutate(Open = replace(Open, is.na(Open),1))
# b. Check if NA has been replaced:
test %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>% row_spec(5, bold = T, color = "red")
# Initialize mice algorithm where it use information from other variables in the dataset to predict and impute the missing values
init = mice(store, maxit = 0)
meth = init$method
predM = init$predictorMatrix
# Store ID variable does not have any predictive value, Select the BMI variable to not be included as predictor during imputation
predM[, c("Store")] = 0
# Specify methods for inputing values
meth[c("CompetitionOpenSinceMonth")]="norm"
meth[c("CompetitionOpenSinceYear")]="norm"
meth[c("Promo2SinceWeek")]="norm"
meth[c("Promo2SinceYear")]="norm"
# Run multiple imputation
set.seed(111)
imputed = mice(store, method=meth, predictorMatrix=predM, m=10)
# Replace store with inputed missing value dataset
store <- complete(imputed)
store$CompetitionOpenSinceMonth <- round(store$CompetitionOpenSinceMonth, digits = 0)
store$CompetitionOpenSinceYear <- round(store$CompetitionOpenSinceYear, digits = 0)
store$Promo2SinceWeek <- round(store$Promo2SinceWeek, digits = 0)
store$Promo2SinceYear <- round(store$Promo2SinceYear, digits = 0)
store <- store %>%
mutate(CompetitionOpenSinceMonth = replace(CompetitionOpenSinceMonth, CompetitionOpenSinceMonth<1, 1),
CompetitionOpenSinceMonth = replace(CompetitionOpenSinceMonth, CompetitionOpenSinceMonth>12, 12),
CompetitionOpenSinceYear = replace(CompetitionOpenSinceYear, CompetitionOpenSinceYear>2015, 2015),
Promo2SinceWeek = replace(Promo2SinceWeek, Promo2SinceWeek<1, 1),
Promo2SinceWeek = replace(Promo2SinceWeek, Promo2SinceWeek>50, 50),
Promo2SinceYear = replace(Promo2SinceYear, Promo2SinceYear<2009, 2009),
Promo2SinceYear = replace(Promo2SinceYear, Promo2SinceYear>2015, 2015)
)
# Last check for NAs
store %>% is.na() %>% colSums() %>% data.frame() %>% `colnames<-`("No. of NAs") %>% html_df %>%
row_spec(c(4,5,6,8,9), bold = T, color = "red")
# a. Create new date variables
store <- store %>%
mutate(CompetitionOpenSince = as.yearmon(paste(store$CompetitionOpenSinceYear, store$CompetitionOpenSinceMonth, sep = "-")),
Promo2Since = as.POSIXct(paste(store$Promo2SinceYear,store$Promo2SinceWeek, 1, sep = "-"),format = "%Y-%U-%u"))
# P.S: yearmon functon creates a numeric vector interpreted in "years" and fractions of years. e.g. 1961.5 = June 1961.
# b. Remove redundant date variables
store <- store %>% dplyr::select(-c(Promo2SinceWeek, Promo2SinceYear, CompetitionOpenSinceMonth, CompetitionOpenSinceYear))
train.store <- merge(train, store, by = "Store")
test.store <- merge(test, store, by = "Store")
# rm(store)
# rm(test)
# rm(train)
# Previous stored variables removed so only correct data set is used.
# Histogram for CompetitionOpenedSince
plot_ly(x= train.store$CompetitionOpenSince, type = "histogram") %>%
layout(title = "Distribution of CompetitionOpenedSince",
xaxis = list(title = "Year",
zeroline = FALSE),
yaxis = list(title = "Count",
zeroline = FALSE))
# MeanSales by CompetitionDistance
salesbydist <- train.store %>% group_by(CompetitionDistance) %>% summarise(MeanSales = mean(Sales, na.rm=TRUE))
## NOTE: Plotting without mean makes everthing too cluttered. Code below can't see shit. Followed online guide.
## ggplot(train.store, aes(x = CompetitionDistance, y = Sales)) + geom_point() + geom_smooth()
# salesbydist scatterplot
ggplot(salesbydist, aes(x = CompetitionDistance, y = MeanSales)) +
geom_point() + geom_smooth() + scale_x_log10() + scale_y_log10()
>>>>>>> master
